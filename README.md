# Rust-KV: é«˜æ€§èƒ½ä¼ä¸šçº§å¼‚æ­¥å†…å­˜æ•°æ®åº“

**Rust-KV** æ˜¯ä¸€ä¸ªä»é›¶æ„å»ºçš„ã€å…¼å®¹ Redis åè®® (RESP) çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼å†…å­˜æ•°æ®åº“åŸå‹ã€‚

æœ¬é¡¹ç›®ä¸ä»…æ˜¯ä¸€ä¸ª KV å­˜å‚¨ï¼Œæ›´æ˜¯ä¸€ä¸ªæ·±åº¦æ¢ç´¢ **Rust å¼‚æ­¥è¿è¡Œæ—¶ (Tokio)**ã€**æ— é”ç¼–ç¨‹**ã€**Actor æ¨¡å‹** ä»¥åŠ **FFI é«˜æ€§èƒ½äº¤äº’** çš„å·¥ä¸šçº§å®è·µã€‚å®ƒåœ¨å•æœºç¯å¢ƒä¸‹å®ç°äº†è¶…é«˜å¹¶å‘ä¸æä½å»¶è¿Ÿï¼Œç‰¹åˆ«æ˜¯åœ¨ Lua è„šæœ¬æ‰§è¡Œå¼•æ“ä¸Šï¼Œé€šè¿‡åˆ›æ–°çš„æ¶æ„è®¾è®¡ï¼Œå®ç°äº†è¶…è¶ŠåŸç”Ÿ Redis çš„ ACID ä¿è¯ã€‚

## ğŸš€ æè‡´æ€§èƒ½ (Performance Benchmark)

åŸºäº MacBook Pro (M-Series) æœ¬åœ°å›ç¯æµ‹è¯•ï¼Œåœ¨å¼€å¯ **AOF æŒä¹…åŒ– (fsync enabled)** çš„çœŸå®åœºæ™¯ä¸‹æµ‹å¾—ï¼š

| æµ‹è¯•åœºæ™¯ (Benchmark Scenario) | QPS (Requests/sec) | ç“¶é¢ˆåˆ†æ |
| :--- | :--- | :--- |
| **åŸºç¡€ KV å†™å…¥ (SET)** | **130,000+** | å†…æ ¸çº¯å†…å­˜æ“ä½œæé™ï¼Œç“¶é¢ˆä¸»è¦åœ¨ç³»ç»Ÿè°ƒç”¨ä¸ç½‘ç»œ I/O |
| **ç®€å• Lua è„šæœ¬ (return 'hello')** | **110,000+** | **ThreadLocal ä¸Šä¸‹æ–‡æ³¨å…¥** æ¶ˆé™¤æ‰€æœ‰ FFI å¼€é”€ï¼Œæ¥è¿‘åŸç”Ÿ Rust é€Ÿåº¦ |
| **å¤æ‚äº‹åŠ¡ Lua (GET + Calc + SET)** | **31,000+** | æ¶‰åŠå¤šæ¬¡æ•°æ®åº“è¯»å†™é”ç«äº‰ä¸ AOF åˆ·ç›˜ï¼Œè¡¨ç°æå…¶ç¨³å®š |

> **æµ‹è¯•æŒ‡ä»¤å‚è€ƒ:**
> ```bash
> redis-benchmark -p 6379 -c 100 -n 100000 -q -r 100000 EVAL "..."
> ```

## ğŸ› ï¸ æ ¸å¿ƒæ¶æ„ä¸æŠ€æœ¯äº®ç‚¹ (Core Architecture)

### 1. é©å‘½æ€§çš„å¤šçº¿ç¨‹ Lua å¼•æ“ (Multi-Reactor Lua Engine)
è¿™æ˜¯æœ¬é¡¹ç›®æœ€æ ¸å¿ƒçš„åˆ›æ–°ç‚¹ï¼Œè§£å†³äº† Redis å•çº¿ç¨‹è„šæœ¬é˜»å¡çš„ç—›ç‚¹ï¼ŒåŒæ—¶ä¿è¯äº†æ¯” Redis æ›´å¼ºçš„æ•°æ®ä¸€è‡´æ€§ã€‚

* **Actor æ¨¡å‹æ¶æ„:** å¯åŠ¨ N ä¸ªï¼ˆé»˜è®¤ 8 ä¸ªï¼‰ç‹¬ç«‹çš„ OS çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ç‹¬å ä¸€ä¸ª Lua è™šæ‹Ÿæœº (`mlua::Lua`)ã€‚å¤–éƒ¨è¯·æ±‚é€šè¿‡ `flume/mpsc` é€šé“åˆ†å‘ï¼Œå®ç°äº†è®¡ç®—ä¸ I/O çš„å½»åº•åˆ†ç¦»ã€‚
* **ThreadLocal é›¶å¼€é”€æ³¨å…¥ (Zero-Overhead Injection):**
    * æ‹’ç»æ¯æ¬¡è¯·æ±‚é‡å¤åˆ›å»º Lua ä¸Šä¸‹æ–‡ã€‚
    * åˆ©ç”¨ Rust çš„ `thread_local!`ï¼Œåœ¨çº¿ç¨‹å¯åŠ¨æ—¶ä¸€æ¬¡æ€§æ³¨å†Œ `redis.call` ç»‘å®šã€‚
    * è¿è¡Œæ—¶ä»…é€šè¿‡ TLS æŒ‡é’ˆäº¤æ¢ä¸Šä¸‹æ–‡ (`CURRENT_ENV`)ï¼Œå°† FFI è°ƒç”¨å¼€é”€é™è‡³çº³ç§’çº§ï¼Œä»è€Œå®ç°äº† **11w+ QPS** çš„æƒŠäººæ€§èƒ½ã€‚
* **æ™ºèƒ½è´Ÿè½½å‡è¡¡ (Queue-Aware Dispatch):** è°ƒåº¦å™¨å®æ—¶ç›‘æ§æ¯ä¸ª Worker çš„é˜Ÿåˆ—æ·±åº¦ (`capacity`)ï¼Œè‡ªåŠ¨å°†ä»»åŠ¡åˆ†å‘ç»™æœ€ç©ºé—²çš„çº¿ç¨‹ï¼Œé¿å…äº† Round-Robin å¯¼è‡´çš„é˜Ÿå¤´é˜»å¡ (Head-of-Line Blocking) é—®é¢˜ã€‚

### 2. çœŸÂ·ACID äº‹åŠ¡æ”¯æŒ (True ACID Transactions)
è¶…è¶Š Redis çš„ "Scripting" è¯­ä¹‰ï¼Œå®ç°äº†çœŸæ­£çš„æ•°æ®åº“çº§äº‹åŠ¡ã€‚

* **å†™ç¼“å†² (Write Buffering):** Lua è„šæœ¬æ‰§è¡ŒæœŸé—´ï¼Œæ‰€æœ‰çš„å†™å…¥æ“ä½œ (`SET`, `DEL`) ä¸ä¼šç›´æ¥ä¿®æ”¹åº•å±‚æ•°æ®ï¼Œè€Œæ˜¯è®°å½•åœ¨ `LuaCacheNode` çš„ `differ_map` å·®å¼‚ç¼“å†²åŒºä¸­ã€‚
* **åŸå­æäº¤ä¸å›æ»š (Commit or Rollback):**
    * **Success:** åªæœ‰è„šæœ¬æˆåŠŸè¿”å›ï¼Œå·®å¼‚æ•°æ®æ‰ä¼šåŸå­æ€§åœ°åº”ç”¨åˆ°åº•å±‚å­˜å‚¨ã€‚
    * **Failure:** å¦‚æœè„šæœ¬ä¸­é€”æŠ¥é”™ï¼ˆPanic æˆ– Errorï¼‰ï¼Œç¼“å†²åŒºç›´æ¥ä¸¢å¼ƒï¼Œåº•å±‚æ•°æ®æ¯«å‘æ— æŸã€‚
* **å¯¹æ¯”:** åŸç”Ÿ Redis è„šæœ¬è‹¥ä¸­é€”å¤±è´¥ï¼Œå·²æ‰§è¡Œçš„å†™æ“ä½œæ— æ³•æ’¤é”€ï¼Œç ´ååŸå­æ€§ã€‚

### 3. ç²¾ç»†åŒ–åˆ†ç‰‡é”æ¶æ„ (Sharded Locking)
ä¸ºäº†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æœ€å¤§åŒ–å¹¶å‘åº¦ï¼Œå½»åº•æ‘’å¼ƒå…¨å±€å¤§é”ã€‚

* **ä¸¤çº§åˆ†ç‰‡:** `16 Databases` Ã— `64 Shards/DB` = **1024 ä¸ªç‹¬ç«‹çš„é”åŸŸ**ã€‚
* **æ— é”å“ˆå¸Œ:** é‡‡ç”¨ `fxhash` è¿›è¡Œæé€Ÿè·¯ç”±ã€‚
* **é”ç²’åº¦æ§åˆ¶:** è¯»å†™æ“ä½œä»…é”å®š Key æ‰€åœ¨çš„ç‰¹å®šåˆ†ç‰‡ (`RwLock`)ï¼Œä½¿å¾— 99% çš„å¹¶å‘è¯·æ±‚å®Œå…¨æ— ç«äº‰ã€‚

### 4. æ™ºèƒ½ AOF æŒä¹…åŒ– (Smart Batching AOF)
è§£å†³äº†é«˜å¹¶å‘å†™å…¥ä¸‹çš„ç£ç›˜ I/O ç“¶é¢ˆã€‚

* **èƒŒå‹ä¸å‰Šå³°:** AOF é€šé“ (`mpsc::channel`) ä½œä¸ºå¤©ç„¶çš„ç¼“å†²åŒºï¼Œå¸æ”¶çªå‘æµé‡ã€‚
* **è´ªå©ªæ‰¹å¤„ç† (Greedy Batching):** åå°è½ç›˜ä»»åŠ¡ (`aof_writer_task`) é‡‡ç”¨â€œè´ªå©ªæ¨¡å¼â€ï¼šä¸€æ—¦å”¤é†’ï¼Œä¼šå°½å¯èƒ½å¤šåœ°ä»é€šé“ä¸­æ‹‰å–ç§¯å‹æ•°æ®ï¼ˆæ¯”å¦‚ä¸€æ¬¡ 5000 æ¡ï¼‰ï¼Œåˆå¹¶ä¸ºä¸€æ¬¡ `write_all` å’Œ `flush` ç³»ç»Ÿè°ƒç”¨ã€‚è¿™ä½¿å¾—ç³»ç»Ÿåœ¨ IOPS æœ‰é™çš„ SSD ä¸Šä¹Ÿèƒ½è·‘æ»¡å¸¦å®½ã€‚

### 5. å¥å£®çš„å·¥ç¨‹åŒ–å®ç°
* **ä¼˜é›…åœæœº (Graceful Shutdown):** åŸºäº `broadcast` é€šé“å®ç°çš„åŒå±‚åœæœºï¼ˆåº”ç”¨å±‚ -> åŸºç¡€è®¾æ–½å±‚ï¼‰ï¼Œç¡®ä¿åœ¨æœåŠ¡å…³é—­å‰ï¼Œæ‰€æœ‰æŒ‚èµ·çš„ AOF æ•°æ®éƒ½è¢«åˆ·å…¥ç£ç›˜ï¼Œæ•°æ®é›¶ä¸¢å¤±ã€‚
* **Unsafe æ‰‹å†™ LRU:** ä¸ºäº†è¿½æ±‚æè‡´çš„ `O(1)` æ·˜æ±°æ€§èƒ½ï¼Œä½¿ç”¨ `NonNull` è£¸æŒ‡é’ˆæ‰‹å†™åŒå‘é“¾è¡¨ï¼Œç»“åˆ `HashMap` ç´¢å¼•ï¼Œå®ç°äº†ç”Ÿäº§çº§çš„ LRU æ·˜æ±°ç®—æ³•ã€‚
* **é›¶æ‹·è´åè®®è§£æ:** åŸºäº `bytes::BytesMut` å’Œ `Cursor` å®ç°çš„ RESP è§£æå™¨ï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­é›¶å†…å­˜åˆ†é…ã€‚

## å¿«é€Ÿå¼€å§‹ (Getting Started)

### ç¯å¢ƒè¦æ±‚
* Rust (Latest Stable)
* Redis-cli (ç”¨äºæµ‹è¯•äº¤äº’)

### è¿è¡ŒæœåŠ¡å™¨

1. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone [https://github.com/your-repo/kv-rs.git](https://github.com/your-repo/kv-rs.git)